var $builtinmodule = function (name) {
    var s = {
	};
THECOLORS = {
	aliceblue:"rgb(240,248,255)",antiquewhite:"rgb(250,235,215)",antiquewhite1:"rgb(255,239,219)",antiquewhite2:"rgb(238,223,204)",antiquewhite3:"rgb(205,192,176)",antiquewhite4:"rgb(139,131,120)",aqua:"rgb(0,255,255)",aquamarine:"rgb(127,255,212)",aquamarine1:"rgb(127,255,212)",aquamarine2:"rgb(118,238,198)",aquamarine3:"rgb(102,205,170)",aquamarine4:"rgb(69,139,116)",azure:"rgb(240,255,255)",azure1:"rgb(240,255,255)",azure3:"rgb(193,205,205)",azure2:"rgb(224,238,238)",azure4:"rgb(131,139,139)",beige:"rgb(245,245,220)",bisque:"rgb(255,228,196)",bisque1:"rgb(255,228,196)",bisque2:"rgb(238,213,183)",bisque3:"rgb(205,183,158)",bisque4:"rgb(139,125,107)",black:"rgb(0,0,0)",blanchedalmond:"rgb(255,235,205)",blue:"rgb(0,0,255)",blue1:"rgb(0,0,255)",blue2:"rgb(0,0,238)",blue3:"rgb(0,0,205)",blue4:"rgb(0,0,139)",blueviolet:"rgb(138,43,226)",brown:"rgb(165,42,42)",brown1:"rgb(255,64,64)",brown2:"rgb(238,59,59)",brown3:"rgb(205,51,51)",brown4:"rgb(139,35,35)",burlywood:"rgb(222,184,135)",burlywood1:"rgb(255,211,155)",burlywood2:"rgb(238,197,145)",burlywood3:"rgb(205,170,125)",burlywood4:"rgb(139,115,85)",cadetblue:"rgb(95,158,160)",cadetblue1:"rgb(152,245,255)",cadetblue2:"rgb(142,229,238)",cadetblue3:"rgb(122,197,205)",cadetblue4:"rgb(83,134,139)",chartreuse:"rgb(127,255,0)",chartreuse1:"rgb(127,255,0)",chartreuse2:"rgb(118,238,0)",chartreuse3:"rgb(102,205,0)",chartreuse4:"rgb(69,139,0)",chocolate:"rgb(210,105,30)",chocolate1:"rgb(255,127,36)",chocolate2:"rgb(238,118,33)",chocolate3:"rgb(205,102,29)",chocolate4:"rgb(139,69,19)",coral:"rgb(255,127,80)",coral1:"rgb(255,114,86)",coral2:"rgb(238,106,80)",coral3:"rgb(205,91,69)",coral4:"rgb(139,62,47)",cornflowerblue:"rgb(100,149,237)",cornsilk:"rgb(255,248,220)",cornsilk1:"rgb(255,248,220)",cornsilk2:"rgb(238,232,205)",cornsilk3:"rgb(205,200,177)",cornsilk4:"rgb(139,136,120)",crimson:"rgb(220,20,60)",cyan:"rgb(0,255,255)",cyan1:"rgb(0,255,255)",cyan2:"rgb(0,238,238)",cyan3:"rgb(0,205,205)",cyan4:"rgb(0,139,139)",darkblue:"rgb(0,0,139)",darkcyan:"rgb(0,139,139)",darkgoldenrod:"rgb(184,134,11)",darkgoldenrod1:"rgb(255,185,15)",darkgoldenrod2:"rgb(238,173,14)",darkgoldenrod3:"rgb(205,149,12)",darkgoldenrod4:"rgb(139,101,8)",darkgray:"rgb(169,169,169)",darkgreen:"rgb(0,100,0)",darkgrey:"rgb(169,169,169)",darkkhaki:"rgb(189,183,107)",darkmagenta:"rgb(139,0,139)",darkolivegreen:"rgb(85,107,47)",darkolivegreen1:"rgb(202,255,112)",darkolivegreen2:"rgb(188,238,104)",darkolivegreen3:"rgb(162,205,90)",darkolivegreen4:"rgb(110,139,61)",darkorange:"rgb(255,140,0)",darkorange1:"rgb(255,127,0)",darkorange2:"rgb(238,118,0)",darkorange3:"rgb(205,102,0)",darkorange4:"rgb(139,69,0)",darkorchid:"rgb(153,50,204)",darkorchid1:"rgb(191,62,255)",darkorchid2:"rgb(178,58,238)",darkorchid3:"rgb(154,50,205)",darkorchid4:"rgb(104,34,139)",darkred:"rgb(139,0,0)",darksalmon:"rgb(233,150,122)",darkseagreen:"rgb(143,188,143)",darkseagreen1:"rgb(193,255,193)",darkseagreen2:"rgb(180,238,180)",darkseagreen3:"rgb(155,205,155)",darkseagreen4:"rgb(105,139,105)",darkslateblue:"rgb(72,61,139)",darkslategray:"rgb(47,79,79)",darkslategray1:"rgb(151,255,255)",darkslategray2:"rgb(141,238,238)",darkslategray3:"rgb(121,205,205)",darkslategray4:"rgb(82,139,139)",darkslategrey:"rgb(47,79,79)",darkturquoise:"rgb(0,206,209)",darkviolet:"rgb(148,0,211)",deeppink:"rgb(255,20,147)",deeppink1:"rgb(255,20,147)",deeppink2:"rgb(238,18,137)",deeppink3:"rgb(205,16,118)",deeppink4:"rgb(139,10,80)",deepskyblue:"rgb(0,191,255)",deepskyblue1:"rgb(0,191,255)",deepskyblue2:"rgb(0,178,238)",deepskyblue3:"rgb(0,154,205)",deepskyblue4:"rgb(0,104,139)",dimgray:"rgb(105,105,105)",dimgrey:"rgb(105,105,105)",dodgerblue:"rgb(30,144,255)",dodgerblue1:"rgb(30,144,255)",dodgerblue2:"rgb(28,134,238)",dodgerblue3:"rgb(24,116,205)",dodgerblue4:"rgb(16,78,139)",firebrick:"rgb(178,34,34)",firebrick1:"rgb(255,48,48)",firebrick2:"rgb(238,44,44)",firebrick3:"rgb(205,38,38)",firebrick4:"rgb(139,26,26)",floralwhite:"rgb(255,250,240)",forestgreen:"rgb(34,139,34)",fuchsia:"rgb(255,0,255)",gainsboro:"rgb(220,220,220)",ghostwhite:"rgb(248,248,255)",gold:"rgb(255,215,0)",gold1:"rgb(255,215,0)",gold2:"rgb(238,201,0)",gold3:"rgb(205,173,0)",gold4:"rgb(139,117,0)",goldenrod:"rgb(218,165,32)",goldenrod1:"rgb(255,193,37)",goldenrod2:"rgb(238,180,34)",goldenrod3:"rgb(205,155,29)",goldenrod4:"rgb(139,105,20)",gray:"rgb(190,190,190)",gray0:"rgb(0,0,0)",gray1:"rgb(3,3,3)",gray2:"rgb(5,5,5)",gray3:"rgb(8,8,8)",gray4:"rgb(10,10,10)",gray5:"rgb(13,13,13)",gray6:"rgb(15,15,15)",gray7:"rgb(18,18,18)",gray8:"rgb(20,20,20)",gray9:"rgb(23,23,23)",gray10:"rgb(26,26,26)",gray11:"rgb(28,28,28)",gray12:"rgb(31,31,31)",gray13:"rgb(33,33,33)",gray14:"rgb(36,36,36)",gray15:"rgb(38,38,38)",gray16:"rgb(41,41,41)",gray17:"rgb(43,43,43)",gray18:"rgb(46,46,46)",gray19:"rgb(48,48,48)",gray20:"rgb(51,51,51)",gray21:"rgb(54,54,54)",gray22:"rgb(56,56,56)",gray23:"rgb(59,59,59)",gray24:"rgb(61,61,61)",gray25:"rgb(64,64,64)",gray26:"rgb(66,66,66)",gray27:"rgb(69,69,69)",gray28:"rgb(71,71,71)",gray29:"rgb(74,74,74)",gray30:"rgb(77,77,77)",gray31:"rgb(79,79,79)",gray32:"rgb(82,82,82)",gray33:"rgb(84,84,84)",gray34:"rgb(87,87,87)",gray35:"rgb(89,89,89)",gray36:"rgb(92,92,92)",gray37:"rgb(94,94,94)",gray38:"rgb(97,97,97)",gray39:"rgb(99,99,99)",gray40:"rgb(102,102,102)",gray41:"rgb(105,105,105)",gray42:"rgb(107,107,107)",gray43:"rgb(110,110,110)",gray44:"rgb(112,112,112)",gray45:"rgb(115,115,115)",gray46:"rgb(117,117,117)",gray47:"rgb(120,120,120)",gray48:"rgb(122,122,122)",gray49:"rgb(125,125,125)",gray50:"rgb(127,127,127)",gray51:"rgb(130,130,130)",gray52:"rgb(133,133,133)",gray53:"rgb(135,135,135)",gray54:"rgb(138,138,138)",gray55:"rgb(140,140,140)",gray56:"rgb(143,143,143)",gray57:"rgb(145,145,145)",gray58:"rgb(148,148,148)",gray59:"rgb(150,150,150)",gray60:"rgb(153,153,153)",gray61:"rgb(156,156,156)",gray62:"rgb(158,158,158)",gray63:"rgb(161,161,161)",gray64:"rgb(163,163,163)",gray65:"rgb(166,166,166)",gray66:"rgb(168,168,168)",gray67:"rgb(171,171,171)",gray68:"rgb(173,173,173)",gray69:"rgb(176,176,176)",gray70:"rgb(179,179,179)",gray71:"rgb(181,181,181)",gray72:"rgb(184,184,184)",gray73:"rgb(186,186,186)",gray74:"rgb(189,189,189)",gray75:"rgb(191,191,191)",gray76:"rgb(194,194,194)",gray77:"rgb(196,196,196)",gray78:"rgb(199,199,199)",gray79:"rgb(201,201,201)",gray80:"rgb(204,204,204)",gray81:"rgb(207,207,207)",gray82:"rgb(209,209,209)",gray83:"rgb(212,212,212)",gray84:"rgb(214,214,214)",gray85:"rgb(217,217,217)",gray86:"rgb(219,219,219)",gray87:"rgb(222,222,222)",gray88:"rgb(224,224,224)",gray89:"rgb(227,227,227)",gray90:"rgb(229,229,229)",gray91:"rgb(232,232,232)",gray92:"rgb(235,235,235)",gray93:"rgb(237,237,237)",gray94:"rgb(240,240,240)",gray95:"rgb(242,242,242)",gray96:"rgb(245,245,245)",gray97:"rgb(247,247,247)",gray98:"rgb(250,250,250)",gray99:"rgb(252,252,252)",gray100:"rgb(255,255,255)",green:"rgb(0,255,0)",green1:"rgb(0,255,0)",green2:"rgb(0,238,0)",green3:"rgb(0,205,0)",green4:"rgb(0,139,0)",greenyellow:"rgb(173,255,47)",grey:"rgb(190,190,190)",grey0:"rgb(0,0,0)",grey1:"rgb(3,3,3)",grey2:"rgb(5,5,5)",grey3:"rgb(8,8,8)",grey4:"rgb(10,10,10)",grey5:"rgb(13,13,13)",grey6:"rgb(15,15,15)",grey7:"rgb(18,18,18)",grey8:"rgb(20,20,20)",grey9:"rgb(23,23,23)",grey10:"rgb(26,26,26)",grey11:"rgb(28,28,28)",grey12:"rgb(31,31,31)",grey13:"rgb(33,33,33)",grey14:"rgb(36,36,36)",grey15:"rgb(38,38,38)",grey16:"rgb(41,41,41)",grey17:"rgb(43,43,43)",grey18:"rgb(46,46,46)",grey19:"rgb(48,48,48)",grey20:"rgb(51,51,51)",grey21:"rgb(54,54,54)",grey22:"rgb(56,56,56)",grey23:"rgb(59,59,59)",grey24:"rgb(61,61,61)",grey25:"rgb(64,64,64)",grey26:"rgb(66,66,66)",grey27:"rgb(69,69,69)",grey28:"rgb(71,71,71)",grey29:"rgb(74,74,74)",grey30:"rgb(77,77,77)",grey31:"rgb(79,79,79)",grey32:"rgb(82,82,82)",grey33:"rgb(84,84,84)",grey34:"rgb(87,87,87)",grey35:"rgb(89,89,89)",grey36:"rgb(92,92,92)",grey37:"rgb(94,94,94)",grey38:"rgb(97,97,97)",grey39:"rgb(99,99,99)",grey40:"rgb(102,102,102)",grey41:"rgb(105,105,105)",grey42:"rgb(107,107,107)",grey43:"rgb(110,110,110)",grey44:"rgb(112,112,112)",grey45:"rgb(115,115,115)",grey46:"rgb(117,117,117)",grey47:"rgb(120,120,120)",grey48:"rgb(122,122,122)",grey49:"rgb(125,125,125)",grey50:"rgb(127,127,127)",grey51:"rgb(130,130,130)",grey52:"rgb(133,133,133)",grey53:"rgb(135,135,135)",grey54:"rgb(138,138,138)",grey55:"rgb(140,140,140)",grey56:"rgb(143,143,143)",grey57:"rgb(145,145,145)",grey58:"rgb(148,148,148)",grey59:"rgb(150,150,150)",grey60:"rgb(153,153,153)",grey61:"rgb(156,156,156)",grey62:"rgb(158,158,158)",grey63:"rgb(161,161,161)",grey64:"rgb(163,163,163)",grey65:"rgb(166,166,166)",grey66:"rgb(168,168,168)",grey67:"rgb(171,171,171)",grey68:"rgb(173,173,173)",grey69:"rgb(176,176,176)",grey70:"rgb(179,179,179)",grey71:"rgb(181,181,181)",grey72:"rgb(184,184,184)",grey73:"rgb(186,186,186)",grey74:"rgb(189,189,189)",grey75:"rgb(191,191,191)",grey76:"rgb(194,194,194)",grey77:"rgb(196,196,196)",grey78:"rgb(199,199,199)",grey79:"rgb(201,201,201)",grey80:"rgb(204,204,204)",grey81:"rgb(207,207,207)",grey82:"rgb(209,209,209)",grey83:"rgb(212,212,212)",grey84:"rgb(214,214,214)",grey85:"rgb(217,217,217)",grey86:"rgb(219,219,219)",grey87:"rgb(222,222,222)",grey88:"rgb(224,224,224)",grey89:"rgb(227,227,227)",grey90:"rgb(229,229,229)",grey91:"rgb(232,232,232)",grey92:"rgb(235,235,235)",grey93:"rgb(237,237,237)",grey94:"rgb(240,240,240)",grey95:"rgb(242,242,242)",grey96:"rgb(245,245,245)",grey97:"rgb(247,247,247)",grey98:"rgb(250,250,250)",grey99:"rgb(252,252,252)",grey100:"rgb(255,255,255)",honeydew:"rgb(240,255,240)",honeydew1:"rgb(240,255,240)",honeydew2:"rgb(224,238,224)",honeydew3:"rgb(193,205,193)",honeydew4:"rgb(131,139,131)",hotpink:"rgb(255,105,180)",hotpink1:"rgb(255,110,180)",hotpink2:"rgb(238,106,167)",hotpink3:"rgb(205,96,144)",hotpink4:"rgb(139,58,98)",indianred:"rgb(205,92,92)",indianred1:"rgb(255,106,106)",indianred2:"rgb(238,99,99)",indianred3:"rgb(205,85,85)",indianred4:"rgb(139,58,58)",indigo:"rgb(75,0,130)",ivory:"rgb(255,255,240)",ivory1:"rgb(255,255,240)",ivory2:"rgb(238,238,224)",ivory3:"rgb(205,205,193)",ivory4:"rgb(139,139,131)",khaki:"rgb(240,230,140)",khaki1:"rgb(255,246,143)",khaki2:"rgb(238,230,133)",khaki3:"rgb(205,198,115)",khaki4:"rgb(139,134,78)",lavender:"rgb(230,230,250)",lavenderblush:"rgb(255,240,245)",lavenderblush1:"rgb(255,240,245)",lavenderblush2:"rgb(238,224,229)",lavenderblush3:"rgb(205,193,197)",lavenderblush4:"rgb(139,131,134)",lawngreen:"rgb(124,252,0)",lemonchiffon:"rgb(255,250,205)",lemonchiffon1:"rgb(255,250,205)",lemonchiffon2:"rgb(238,233,191)",lemonchiffon3:"rgb(205,201,165)",lemonchiffon4:"rgb(139,137,112)",lightblue:"rgb(173,216,230)",lightblue1:"rgb(191,239,255)",lightblue2:"rgb(178,223,238)",lightblue3:"rgb(154,192,205)",lightblue4:"rgb(104,131,139)",lightcoral:"rgb(240,128,128)",lightcyan:"rgb(224,255,255)",lightcyan1:"rgb(224,255,255)",lightcyan2:"rgb(209,238,238)",lightcyan3:"rgb(180,205,205)",lightcyan4:"rgb(122,139,139)",lightgoldenrod:"rgb(238,221,130)",lightgoldenrod1:"rgb(255,236,139)",lightgoldenrod2:"rgb(238,220,130)",lightgoldenrod3:"rgb(205,190,112)",lightgoldenrod4:"rgb(139,129,76)",lightgoldenrodyellow:"rgb(250,250,210)",lightgray:"rgb(211,211,211)",lightgreen:"rgb(144,238,144)",lightgrey:"rgb(211,211,211)",lightpink:"rgb(255,182,193)",lightpink1:"rgb(255,174,185)",lightpink2:"rgb(238,162,173)",lightpink3:"rgb(205,140,149)",lightpink4:"rgb(139,95,101)",lightsalmon:"rgb(255,160,122)",lightsalmon1:"rgb(255,160,122)",lightsalmon2:"rgb(238,149,114)",lightsalmon3:"rgb(205,129,98)",lightsalmon4:"rgb(139,87,66)",lightseagreen:"rgb(32,178,170)",lightskyblue:"rgb(135,206,250)",lightskyblue1:"rgb(176,226,255)",lightskyblue2:"rgb(164,211,238)",lightskyblue3:"rgb(141,182,205)",lightskyblue4:"rgb(96,123,139)",lightslateblue:"rgb(132,112,255)",lightslategray:"rgb(119,136,153)",lightslategrey:"rgb(119,136,153)",lightsteelblue:"rgb(176,196,222)",lightsteelblue1:"rgb(202,225,255)",lightsteelblue2:"rgb(188,210,238)",lightsteelblue3:"rgb(162,181,205)",lightsteelblue4:"rgb(110,123,139)",lightyellow:"rgb(255,255,224)",lightyellow1:"rgb(255,255,224)",lightyellow2:"rgb(238,238,209)",lightyellow3:"rgb(205,205,180)",lightyellow4:"rgb(139,139,122)",linen:"rgb(250,240,230)",lime:"rgb(0,255,0)",limegreen:"rgb(50,205,50)",magenta:"rgb(255,0,255)",magenta1:"rgb(255,0,255)",magenta2:"rgb(238,0,238)",magenta3:"rgb(205,0,205)",magenta4:"rgb(139,0,139)",maroon:"rgb(176,48,96)",maroon1:"rgb(255,52,179)",maroon2:"rgb(238,48,167)",maroon3:"rgb(205,41,144)",maroon4:"rgb(139,28,98)",mediumaquamarine:"rgb(102,205,170)",mediumblue:"rgb(0,0,205)",mediumorchid:"rgb(186,85,211)",mediumorchid1:"rgb(224,102,255)",mediumorchid2:"rgb(209,95,238)",mediumorchid3:"rgb(180,82,205)",mediumorchid4:"rgb(122,55,139)",mediumpurple:"rgb(147,112,219)",mediumpurple1:"rgb(171,130,255)",mediumpurple2:"rgb(159,121,238)",mediumpurple3:"rgb(137,104,205)",mediumpurple4:"rgb(93,71,139)",mediumseagreen:"rgb(60,179,113)",mediumslateblue:"rgb(123,104,238)",mediumspringgreen:"rgb(0,250,154)",mediumturquoise:"rgb(72,209,204)",mediumvioletred:"rgb(199,21,133)",midnightblue:"rgb(25,25,112)",mintcream:"rgb(245,255,250)",mistyrose:"rgb(255,228,225)",mistyrose1:"rgb(255,228,225)",mistyrose2:"rgb(238,213,210)",mistyrose3:"rgb(205,183,181)",mistyrose4:"rgb(139,125,123)",moccasin:"rgb(255,228,181)",navajowhite:"rgb(255,222,173)",navajowhite1:"rgb(255,222,173)",navajowhite2:"rgb(238,207,161)",navajowhite3:"rgb(205,179,139)",navajowhite4:"rgb(139,121,94)",navy:"rgb(0,0,128)",navyblue:"rgb(0,0,128)",oldlace:"rgb(253,245,230)",olive:"rgb(128,128,0)",olivedrab:"rgb(107,142,35)",olivedrab1:"rgb(192,255,62)",olivedrab2:"rgb(179,238,58)",olivedrab3:"rgb(154,205,50)",olivedrab4:"rgb(105,139,34)",orange:"rgb(255,165,0)",orange1:"rgb(255,165,0)",orange2:"rgb(238,154,0)",orange3:"rgb(205,133,0)",orange4:"rgb(139,90,0)",orangered:"rgb(255,69,0)",orangered1:"rgb(255,69,0)",orangered2:"rgb(238,64,0)",orangered3:"rgb(205,55,0)",orangered4:"rgb(139,37,0)",orchid:"rgb(218,112,214)",orchid1:"rgb(255,131,250)",orchid2:"rgb(238,122,233)",orchid3:"rgb(205,105,201)",orchid4:"rgb(139,71,137)",palegreen:"rgb(152,251,152)",palegreen1:"rgb(154,255,154)",palegreen2:"rgb(144,238,144)",palegreen3:"rgb(124,205,124)",palegreen4:"rgb(84,139,84)",palegoldenrod:"rgb(238,232,170)",paleturquoise:"rgb(175,238,238)",paleturquoise1:"rgb(187,255,255)",paleturquoise2:"rgb(174,238,238)",paleturquoise3:"rgb(150,205,205)",paleturquoise4:"rgb(102,139,139)",palevioletred:"rgb(219,112,147)",palevioletred1:"rgb(255,130,171)",palevioletred2:"rgb(238,121,159)",palevioletred3:"rgb(205,104,137)",palevioletred4:"rgb(139,71,93)",papayawhip:"rgb(255,239,213)",peachpuff:"rgb(255,218,185)",peachpuff1:"rgb(255,218,185)",peachpuff2:"rgb(238,203,173)",peachpuff3:"rgb(205,175,149)",peachpuff4:"rgb(139,119,101)",peru:"rgb(205,133,63)",pink:"rgb(255,192,203)",pink1:"rgb(255,181,197)",pink2:"rgb(238,169,184)",pink3:"rgb(205,145,158)",pink4:"rgb(139,99,108)",plum:"rgb(221,160,221)",plum1:"rgb(255,187,255)",plum2:"rgb(238,174,238)",plum3:"rgb(205,150,205)",plum4:"rgb(139,102,139)",powderblue:"rgb(176,224,230)",purple:"rgb(160,32,240)",purple1:"rgb(155,48,255)",purple2:"rgb(145,44,238)",purple3:"rgb(125,38,205)",purple4:"rgb(85,26,139)",red:"rgb(255,0,0)",red1:"rgb(255,0,0)",red2:"rgb(238,0,0)",red3:"rgb(205,0,0)",red4:"rgb(139,0,0)",rosybrown:"rgb(188,143,143)",rosybrown1:"rgb(255,193,193)",rosybrown2:"rgb(238,180,180)",rosybrown3:"rgb(205,155,155)",rosybrown4:"rgb(139,105,105)",royalblue:"rgb(65,105,225)",royalblue1:"rgb(72,118,255)",royalblue2:"rgb(67,110,238)",royalblue3:"rgb(58,95,205)",royalblue4:"rgb(39,64,139)",salmon:"rgb(250,128,114)",salmon1:"rgb(255,140,105)",salmon2:"rgb(238,130,98)",salmon3:"rgb(205,112,84)",salmon4:"rgb(139,76,57)",saddlebrown:"rgb(139,69,19)",sandybrown:"rgb(244,164,96)",seagreen:"rgb(46,139,87)",seagreen1:"rgb(84,255,159)",seagreen2:"rgb(78,238,148)",seagreen3:"rgb(67,205,128)",seagreen4:"rgb(46,139,87)",seashell:"rgb(255,245,238)",seashell1:"rgb(255,245,238)",seashell2:"rgb(238,229,222)",seashell3:"rgb(205,197,191)",seashell4:"rgb(139,134,130)",sienna:"rgb(160,82,45)",sienna1:"rgb(255,130,71)",sienna2:"rgb(238,121,66)",sienna3:"rgb(205,104,57)",sienna4:"rgb(139,71,38)",silver:"rgb(192,192,192)",skyblue:"rgb(135,206,235)",skyblue1:"rgb(135,206,255)",skyblue2:"rgb(126,192,238)",skyblue3:"rgb(108,166,205)",skyblue4:"rgb(74,112,139)",slateblue:"rgb(106,90,205)",slateblue1:"rgb(131,111,255)",slateblue2:"rgb(122,103,238)",slateblue3:"rgb(105,89,205)",slateblue4:"rgb(71,60,139)",slategray:"rgb(112,128,144)",slategray1:"rgb(198,226,255)",slategray2:"rgb(185,211,238)",slategray3:"rgb(159,182,205)",slategray4:"rgb(108,123,139)",slategrey:"rgb(112,128,144)",snow:"rgb(255,250,250)",snow1:"rgb(255,250,250)",snow2:"rgb(238,233,233)",snow3:"rgb(205,201,201)",snow4:"rgb(139,137,137)",springgreen:"rgb(0,255,127)",springgreen1:"rgb(0,255,127)",springgreen2:"rgb(0,238,118)",springgreen3:"rgb(0,205,102)",springgreen4:"rgb(0,139,69)",steelblue:"rgb(70,130,180)",steelblue1:"rgb(99,184,255)",steelblue2:"rgb(92,172,238)",steelblue3:"rgb(79,148,205)",steelblue4:"rgb(54,100,139)",tan:"rgb(210,180,140)",tan1:"rgb(255,165,79)",tan2:"rgb(238,154,73)",tan3:"rgb(205,133,63)",tan4:"rgb(139,90,43)",teal:"rgb(0,128,128)",thistle:"rgb(216,191,216)",thistle1:"rgb(255,225,255)",thistle2:"rgb(238,210,238)",thistle3:"rgb(205,181,205)",thistle4:"rgb(139,123,139)",tomato:"rgb(255,99,71)",tomato1:"rgb(255,99,71)",tomato2:"rgb(238,92,66)",tomato3:"rgb(205,79,57)",tomato4:"rgb(139,54,38)",turquoise:"rgb(64,224,208)",turquoise1:"rgb(0,245,255)",turquoise2:"rgb(0,229,238)",turquoise3:"rgb(0,197,205)",turquoise4:"rgb(0,134,139)",violet:"rgb(238,130,238)",violetred:"rgb(208,32,144)",violetred1:"rgb(255,62,150)",violetred2:"rgb(238,58,140)",violetred3:"rgb(205,50,120)",violetred4:"rgb(139,34,82)",wheat:"rgb(245,222,179)",wheat1:"rgb(255,231,186)",wheat2:"rgb(238,216,174)",wheat3:"rgb(205,186,150)",wheat4:"rgb(139,126,102)",white:"rgb(255,255,255)",whitesmoke:"rgb(245,245,245)",yellow:"rgb(255,255,0)",yellow1:"rgb(255,255,0)",yellow2:"rgb(238,238,0)",yellow3:"rgb(205,205,0)",yellow4:"rgb(139,139,0)",yellowgreen:"rgb(154,205,50)"
}
	var handlers = {
		"Sk.debug": function(e) {
			debugger;
			var r = PythonIDE.debugHandler(e);
			if(r.then){
				return r;
			}
			return false;
		}
	};
	//var handlers = {};

	var startTime = new Date().getTime();
	var lineCount = 0;
	var width = undefined;
	var height = undefined;
	var startTime = new Date().getTime();


	Sk.globals.dbg = new Sk.builtin.func(function(x) {
		console.log(x, Sk.ffi.remapToJs(x));
	});

	function updateCoordsFromProps(props, size, pos) {		
		props.x = 0;
		props.y = 0;
		if(pos) {
			props.x = pos[0];
			props.y = pos[1];
		}

		if(props.top !== undefined) {
			props.y = props.top;
		}
		if(props.left !== undefined) {
			props.x = props.left;
		}
		if(props.bottom !== undefined) {
			props.y = props.bottom - size.height;
		}
		if(props.right !== undefined) {
			props.x = props.left - size.width;
		}
		if(props.topleft !== undefined) {
			props.x = props.topleft[0];
			props.y = props.topleft[1];
		}
		if(props.bottomleft !== undefined) {
			props.x = props.bottomleft[0];
			props.y = props.bottomleft[1] - size.height;
		}
		if(props.topright !== undefined) {
			props.x = props.topright[0] - size.width;
			props.y = props.topright[1];
		}
		if(props.bottomright !== undefined) {
			props.x = props.bottomright[0] - size.width;
			props.y = props.bottomright[1] - size.height;
		}
		if(props.midtop !== undefined) {
			props.x = props.midtop[0] - size.width / 2;
			props.y = props.midtop[1];
		}
		if(props.midleft !== undefined) {
			props.x = props.midleft[0];
			props.y = props.midleft[1] - size.height / 2;
		}
		if(props.midbottom !== undefined) {
			props.x = props.midbottom[0] - size.width / 2;
			props.y = props.midbottom[1] - size.height;
		}
		if(props.midright !== undefined) {
			props.x = props.midright[0] - size.width;
			props.y = props.midright[1] - size.height / 2;
		}
		if(props.center !== undefined) {
			props.x = props.center[0] - size.width / 2;
			props.y = props.center[1] - size.height / 2;
		}
		if(props.centerx !== undefined) {
			props.x = props.centerx - size.width / 2;
		}
		if(props.centery !== undefined) {
			props.y = props.centery;
		}
	}

	function getColor(c) {
		var rgb = [255,255,255];
		if (c[0]==='#') {
			var r = parseInt(c.slice(1, 3), 16),
				g = parseInt(c.slice(3, 5), 16),
				b = parseInt(c.slice(5, 7), 16);
		return "rgb(" + r + ", " + g + ", " + b + ")";
		}
		if(THECOLORS && typeof(c) == "string") {
			var cName = c.replace(" ", "");
			if(THECOLORS[cName]) {
				return THECOLORS[cName];	
			}
		} 
		var r = c[0];
		var g = c[1];
		var b = c[2];
		return "rgb(" + r + "," + g + "," + b + ")";
	}

	var canvas = undefined;
	var cx = undefined;

    var default_assets = '{\
  "images": {\
    "$player": {\
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAA7CAYAAADLjIzcAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAADXUlEQVRo3u1ZS2gTQRj+ZpOYbNW1oSRKKYi61SJS6UGFVkpPgmgVqkhFsXjTk8WCWnxQKR6KCi300pOiSBEfUBWKN/F5EBE9FZsqaAkkFaNJm41N0/HSlDYm2d1mZ2e3yQ972OfM9/3f/5hZgKPFOjt9kw37IihWUySZKpJMw/39q3jNgfAEv/BcjAZI0RCQCZ4nCcQq4HmRIJg5GB0YKFN7Zqq2Kb5sFaDmfR4qIFYDbzYJAixqsfoDE8tGAXq9b6YKLKsAAIjtaR2zvQKW6n2zVGBpBQDA5K69EdsqoFDvm6ECpgQEg2FDCKis9NuPAKPAsybB8jmgqMugbQkIBsOfrB5SaXMyIrZW7YGWQd+i88dHJ4onBDLB57pmSwIikUg5w8qStDwBipJk2bk5l0UIFH0ZzJbweCVBwiBOKcsJz87iZFWV/7YlFRAMhs8wl6yAW1YOgV675QAnr4G//3aifdgLADi+fQotW+P2zwFa4j/wy4lzz71Z7610Udw9/NPUlaHpVSAXeACYSpr/p85UArS0u2a3xKVGqERAiYASAVzXAJl2/4h6GQyFQmttq4CG9X/z3nc51JcSiuLwWqoRins3HSIp8jAy8lbzO9dfS3j3ww0AEF0U9zQ0QGnzbmsMYWZmjRgNiNwJiK+ubiWEDgKAHgIKMW9NPZ2b+7QYDbi5rQUUSZ4GqItjC79CkWRayK8zoQDwFAAP8LnmsnQFdPU+2Z1KkVcLro92dzRvZjFg2k48qsDktKCrQqiRkE8JF3uGtghOYWR+YwWYuNbR7BcAIAM8AFSzBN8y6FsE3qg1gCLJlEKWskp9Afg56fsu3Xh2Vbh882lWQJnXE+7qjUb97mZpCQl/lHJ5NB+W+URC6BVBI7NfqZuOwS42C1mrswSNCWaDHdtcLSQIrLKr3paY1ba4GgZD9wQ9L15+TDQ11ukhQUkSiC5+qcXQtYB46kKd7nd0gncPDb+3FAGEkgdiNEDSB2uPVZxu25kei1DaXuj3dIWAR0qUkfFxxSpJzhMb6wPQlyXuU1qdm5eA/zwatUf2F6MBx6I+AKCmJEEAePPh2/nPX8I9dimVTGI2V+dVqHV3NBs+39KeIIuPOggpbgK6zu43nIEaeV2bbQhgYccO7rjD4rv/ACxCMkhHLtaAAAAAAElFTkSuQmCC"\
    },\
    "$alien": {\
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAyCAYAAACj3t7EAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFiklEQVR42u2cbUxTVxjH/+e2Sh1vG1MRRiDSTAZjlEwXx5wovmCkWzRhDVYZI9tYbIiYxrlozCAaWIZiGKhgAu6DcYLpGhPlZQEHvmCI2YcxBzhUsghF4zJxAxHkpXcfsB1NKe29vW/C/Sf9cs/pc8/5/c/znHNKAsELIlLTQTPpfzx6WJutXlEn+XnNBtieiv7gTSIbIDB0qZsh6iDe/el3+sY4NW3bokvn4WMuh6W8wev3hBmSQQjQW+Ycaxmh0aWNJXPKgIiaNroH82bs0xpVAwDQrSt1MiHMkIyAYD989p0eAFBbdgm3r/0JenEE+g5WMIplU1rgv6he/R6Z9QZ4WmoO3S3ARq0GY7UF2H7UH/eP1yH4zDGkfzgfSyIX2/sV6yuwrWALQp4/K9ZX2CEvvFqHvvV7of78NQDwKJuELk1EauBdlRAAMFZlOYA/UpiPxMRVePZsFIlrN9nbi/WTWdBd2Yelx7bh/s6vJbtHEKnDt+ntYj0oioI+byuK9RW40doMALh85RrWrlkNAFiZkORggrf7hxAmKF8E+GGGZOyYsvptWpmQBABQqVS40lzPOv6oNhpnh4HMpltOY+fbBGo2HC1dwbeVLrercHwCGT4E1s1Rgs+Bkjp8VxAtlj7caG22l6Kp5ccmU1OOZyZYlZigAFAKjGpfx7mkGMFMoKQMP6SyEKamHKfnxqospOrSsTIhyf7Rf7OFPYTGTlgBTABQQoGtqlH0rBHGBCLlsuPXdw/b/yhB3Y/tTqt7JtlOQZ4ePe2JkLIMVqIEDRoUbUU7UUBT28nrxixpA6bqsN85KJTUtKDf2vQGNmROnoRGhp5B5evD+hQ0vDkKSqIABRo0PQZl/V2H9uyhdhxPSyOSLEF81srSj085gC9JPwVjVRaMVVl4OTjAboYN/sTy9azes6C+C0N4AkwQEDIPEymOG/MJ31hpliDeTwvj4wjdlTJjKWJbeqbT39oYzAfgNw6UPByEsa2Xl1LE+z2AK1mVSljKG1Csd74VA4D5cC0n4G1a+Lz2d2tjUHfLIu2bsPZiC11HXhHUkJDvj0DxSyOn0Jlo1aN7aPkkxWt+nOwBQsMHgAef7oWlvAGL1EFeXcLY6vqrEdK/CfOeBadLkJ6f6gQ7zJA87f1BivLagMo7LWoxBh5mSMaDjN2T2VBy0cEEa9z70K0r5X0MxoarXh88vK5hOzJ0NOawfjhtIl8V7BuKVNzeABDs3Gdu5d2AuQ7dlWLj1Cf3f/mtgTcDZPDMMoMzA2Tw7LTxndCAzF0lg4wNqLh5Pvpy0dlOJi8zq01I7dZxOgEuYw4HR2HBwy7JZYTDQ9VB2Fe6u4k/XRKFet98l+1swJnVJpdtK7AHEd09nMVjM0Zv4k397kje/9wJG/iuBvNXLo2Rx4N4TGhoSgMZTXC6eJZcGugfgpWah/BSH0bQXMG6s3sAvmPjCC0L4iReb/Y/GCVPYewawYXGSMYmUFzBB4Ccn3/DiMIfmtJAj1aMu3hhhwj6VSqYe8Y4KwUD/v7oV3F3c3+kegmD/kG40Bjptu9UtjbmSm/LxlRVX49H9XVua2dcEbe/Fy7P5/ZPIPFH5zPqn9qtg1ltgpKEA+iZzICRPBAm8D3tK1Y/qSu1W4cnuT3Eq58i3MFgCkuMeFwvOjYLhMjnfHEva5SMQVzJBogsoomPlcuPiFLGxkXLFMTMAHkTFncTdriVyEYIB94hA2QTxIE/rQGyEcKAd2uAbAS/4D02QDaCH/CMDZCN4BY8awNkM7yHzpkBNhUVGg/82mHJl8GLZABfmXEm3sTJeNLbdJIBLogBbA3hCjhXhvABXBQD3JkiFPiZjIjVLD25f89hg9BjkOT/C+qoPEDHDBRwHrci/ITmi4+yb0pprv8B/JVCXMlrL1AAAAAASUVORK5CYII="\
    }}}';

	if(PythonIDE.files['assets.json']) {
		assets = JSON.parse(PythonIDE.files['assets.json']); // якщо наявний файл ресурсів - розбираємо його
	}
	else {
		assets = JSON.parse(default_assets);
		console.log("Assets=",assets);
	}
    
	var loadedAssets = {}; // Тут Завантажені ресурси
// --------------

	var promises = [];
	
	var animations = {};
	
	var animate = function(kwa, object, tween) {
		Sk.builtin.pyCheckArgs("animate", 1, 1);
		args = {};
		var anim = {
			tween: 'linear',
			duration: 1,
			targets: {},
			object: object,
			startTime: (new Date).getTime(),
			progress: 0,
			id: object.id
		};

		if(tween) {
			anim.tween = Sk.ffi.remapToJs(tween);
		}
		
		for(var i = 0; i < kwa.length; i+=2) {
			var key = Sk.ffi.remapToJs(kwa[i]);
			var val = Sk.ffi.remapToJs(kwa[i+1]);
			var targets = {};
			
			switch(key) {
				case 'on_finished':
					val = kwa[i+1];
				case 'tween':
				case 'duration':
					anim[key] = val;
				break;
				case 'pos':
					anim.targets.x = {
						start: Sk.ffi.remapToJs(getActorAttribute(object, Sk.ffi.remapToPy("x"))),
						end: val[0]
					}
					anim.targets.y = {
						start: Sk.ffi.remapToJs(getActorAttribute(object, Sk.ffi.remapToPy("y"))),
						end: val[1]
					}
					anim.id += "_pos";
				break;
				default:
					if(object.attributes[key] !== undefined) {
						anim.targets[key] = {
							start: Sk.ffi.remapToJs(getActorAttribute(object, Sk.ffi.remapToPy(key))),
							end: val
						}
					}
					anim.id += "_" + key;

				break;
			}
		}
		animations[anim.id] = anim;
		//console.log(anim);
		//console.log(animations);
	};
	
	animate.co_kwargs = true;
	
	Sk.globals.animate = new Sk.builtin.func(animate);
	
	function updateRectFromXY(self) {
		var i = loadedAssets[self.attributes.image];
		if(i == undefined) {
			i = {
				width: 0,
				height: 0
			};
		}
		var a = self.attributes;
		a.width = i.width;
		a.height = i.height;

		a.left = a.x;
		a.right = a.x + a.width;
		a.top = a.y;
		a.bottom = a.y + a.height;
		
		self.coords = {
			x1: a.left,
			y1: a.top,
			x2: a.right,
			y2: a.bottom
		}
	}
	
	var updateActorAttribute = function(self, name, value) {
		Sk.builtin.pyCheckArgs("__setattr__", 3, 3);
		name = Sk.ffi.remapToJs(name);
		var a = self.attributes;
		a[name] = Sk.ffi.remapToJs(value);
		console.log('updActor:',name,value);
		var pos = Sk.ffi.remapToJs(value);
		switch(name) {
			case 'x':
				a.x = a.x - self.anchorVal.x;
			break;
			case 'y':
				a.y = a.y - self.anchorVal.y;
			break;
			case 'left':
				a.x = a.left;
			break;
			case 'right':
				a.x = a.right - a.width;
			break;
			case 'top':
				a.y = a.top;
			break;
			case 'bottom':
				a.y = a.bottom - a.height;
			break;
			case 'topleft':
				a.x = pos[0];
				a.y = pos[1];
			break;
			case 'topright':
				a.x = pos[0] - a.width;
				a.y = pos[1];
			break;
			case 'midtop':
				a.x = pos[0] - a.width/2;
				a.y = pos[1];				
			break;
			case 'bottomleft':
				a.x = pos[0];
				a.y = pos[1] - a.height;
			break;
			case 'bottomright':
				a.x = pos[0] - a.width;
				a.y = pos[1] - a.height;
			break;			
			case 'midbottom':
				a.x = pos[0] - a.width/2;
				a.y = pos[1] - a.height;
			break;
			case 'midleft':
				a.x = pos[0];
				a.y = pos[1] - a.height/2;
			break;
			case 'midright':
				a.x = pos[0] - a.width;
				a.y = pos[1] - a.height/2;
			break;
			case 'center':
				a.x = pos[0] - self.anchorVal.x;
				a.y = pos[1] - self.anchorVal.y;
			break;
			case 'anchor':
				self.anchor = Sk.ffi.remapToJs(value);
				updateAnchor(self);
			break;
			case 'pos':				
				a.x = pos[0] - self.anchorVal.x;
				a.y = pos[1] - self.anchorVal.y;
			break;
			default:
			self.others[name] = value;
			break;
		}
		
		
		updateRectFromXY(self);
	};
	
	var getActorAttribute = function(self, name) {
		Sk.builtin.pyCheckArgs("__getattr__", 2, 2);
		name = Sk.ffi.remapToJs(name);
		if (name==='pos'){name='center';}
		if(self.others[name] !== undefined) {
			return self.others[name];
		}
		switch(name) {
			case 'x':
				return Sk.ffi.remapToPy(self.attributes.x + self.anchorVal.x);
			break;
			case 'y':
				return Sk.ffi.remapToPy(self.attributes.y + self.anchorVal.y);
			break;
			case 'center':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([(self.coords.x1 + self.coords.x2) / 2, (self.coords.y1 + self.coords.y2) / 2]));
			break;

		}
		if(self.attributes[name] !== undefined) {
			return Sk.ffi.remapToPy(self.attributes[name]);
		}
		switch(name) {
			case 'anchor':
				return new Sk.builtin.tuple(Sk.ffi.remapToPy(self.anchor));
			break;
		}
	}

	var idCount = 0;

	Sk.globals.ZRect = Sk.globals.Rect = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__repr__ = new Sk.builtin.func(function(self) {
			var x = self.coords.x1;
			var y = self.coords.y1;
			var w = self.coords.x2 - self.coords.x1;
			var h = self.coords.y2 - self.coords.y1;
			return Sk.ffi.remapToPy("Rect (x:" + x + " y:" + y + " w:" + w + " h:" + h + ")");
		});

		$loc.__init__ = new Sk.builtin.func(function(self) {
			Sk.builtin.pyCheckArgs("__init__", 2, 5);
			self.coords = {
				x1: 0,
				y1: 0,
				x2: 0,
				y2: 0
			}

			self.attributes = {};
			
			switch(arguments.length) {
				case 2:
					// either a 4-tuple or rect like object
					switch(arguments[1].tp$name) {
						case 'tuple':
							var coords = Sk.ffi.remapToJs(arguments[1]);
							self.coords = {
								x1: coords[0],
								y1: coords[1],
								x2: coords[2] + coords[0],
								y2: coords[3] + coords[1]
							}
						break;
						default:
							var other = arguments[1];
							self.coords = {
								x1: other.coords.x1,
								x2: other.coords.x2,
								y1: other.coords.y1,
								y2: other.coords.y2
							}
					}
				break;

				case 3:
					// pair of 2-tuples
					var topLeft = Sk.ffi.remapToJs(arguments[1]);
					if(topLeft.length == 2) {
						self.coords.x1 = topLeft[0];
						self.coords.y1 = topLeft[1];
					}

					var dims = Sk.ffi.remapToJs(arguments[2]);
					if(dims.length == 2) {
						self.coords.x2 = self.coords.x1 + dims[0];
						self.coords.y2 = self.coords.y1 + dims[1];
					}
				break;

				case 5:
					// individual coordinates
					self.coords.x1 = Sk.ffi.remapToJs(arguments[1]);
					self.coords.y1 = Sk.ffi.remapToJs(arguments[2]);
					self.coords.x2 = self.coords.x1 + Sk.ffi.remapToJs(arguments[3]);
					self.coords.y2 = self.coords.y1 + Sk.ffi.remapToJs(arguments[4]);

				break;
			}
			
		});

		$loc.__getattr__ = new Sk.builtin.func(function(self, name) {
			var jsName = Sk.ffi.remapToJs(name);
			if (jsName==='x') {jsName ='left';}
			if (jsName==='y') {jsName ='top';}
			if (jsName==='pos') {jsName ='center';}
			console.log('GetAttr:',jsName);
			switch(jsName) {							
				case 'centerx':
					return Sk.ffi.remapToPy((self.coords.x1 + self.coords.x2) / 2);
				break;

				case 'centery':
					return Sk.ffi.remapToPy((self.coords.y1 + self.coords.y2) / 2);
				break;

				case 'center':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([(self.coords.x1 + self.coords.x2) / 2, (self.coords.y1 + self.coords.y2) / 2]));
				break;

				case 'top':
					return Sk.ffi.remapToPy(self.coords.y1);
				break;

				case 'left':
					return Sk.ffi.remapToPy(self.coords.x1);
				break;

				case 'right':
					return Sk.ffi.remapToPy(self.coords.x2);
				break;

				case 'bottom':
					return Sk.ffi.remapToPy(self.coords.y2);
				break;

				case 'bottomleft':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([self.coords.x1, self.coords.y2]));
				break;
				case 'topleft':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([self.coords.x1, self.coords.y1]));
				break;
				case 'bottomright':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([self.coords.x2, self.coords.y2]));
				break;
				case 'topright':
					return new Sk.builtin.tuple(Sk.ffi.remapToPy([self.coords.x2, self.coords.y1]));
				break;

				default:
					if(self.attributes[jsName]) {
						return self.attributes[jsName];
					}
				break;
			}
		});

		$loc.__setattr__ = new Sk.builtin.func(function(self, name, value) {
			var jsName = Sk.ffi.remapToJs(name);
			var jsVal = Sk.ffi.remapToJs(value);
			if (jsName==='x') {jsName ='left';}
			if (jsName==='y') {jsName ='top';}
			console.log('SetAttr:',jsName);
			switch(jsName) {		
				case 'center':
					var oX = jsVal[0] - ((self.coords.x2 - self.coords.x1) / 2) - self.coords.x1;
					var oY = jsVal[1] - ((self.coords.y2 - self.coords.y1) / 2) - self.coords.y1;
					self.coords.x1 += oX;
					self.coords.x2 += oX;
					self.coords.y1 += oY;
					self.coords.y2 += oY;
				break;

				case 'centerx':
					var oX = jsVal - ((self.coords.x2 - self.coords.x1) / 2) - self.coords.x1;
					self.coords.x1 += oX;
					self.coords.x2 += oX;
				break;

				case 'centery':
					var oY = jsVal - ((self.coords.y2 - self.coords.y1) / 2) - self.coords.y1;
					self.coords.y1 += oY;
					self.coords.y2 += oY;
				break;

				case 'left':
					var w = self.coords.x2 - self.coords.x1;
					self.coords.x1 = jsVal;
					self.coords.x2 = self.coords.x1 + w;
				break;

				case 'right':
					var w = self.coords.x2 - self.coords.x1;
					self.coords.x2 = jsVal;
					self.coords.x1 = self.coords.x2 - w;
				break;

				case 'top':
					var h = self.coords.y2 - self.coords.y1;
					self.coords.y1 = jsVal;
					self.coords.y2 = self.coords.y1 + h;
				break;

				case 'bottom':
					var h = self.coords.y2 - self.coords.y1;
					self.coords.y2 = jsVal;
					self.coords.y1 = self.coords.y2 - h;
				break;


				default:
					self.attributes[jsName] = value;
				/*debugger;
					throw new Sk.builtin.NotImplemented("Rect property " + jsName + " not implemented yet");
				break;*/
			}
		});

		$loc.colliderect = new Sk.builtin.func(function(self) {
			var args = [];
			for(var i = 1; i < arguments.length; i++) {
				args.push(arguments[i]);
			}
			var other = Sk.misceval.callsim(Sk.globals.Rect, ...args);
			return Sk.ffi.remapToPy(
            	self.coords.x1 < other.coords.x2 &&
	            self.coords.y1 < other.coords.y2 &&
	            self.coords.x2 > other.coords.x1 &&
	            self.coords.y2 > other.coords.y1
	        );
		});

		$loc.collidelist = new Sk.builtin.func(function(self, others) {
			Sk.builtin.pyCheckArgs("collidelist", 2, 2);
			if(others && others.v && others.v.length) {
				for(var i = 0; i < others.v.length; i++) {
					var other = others.v[i];
					if(self.coords.x1 < other.coords.x2 &&
			            self.coords.y1 < other.coords.y2 &&
			            self.coords.x2 > other.coords.x1 &&
			            self.coords.y2 > other.coords.y1) {
						return Sk.ffi.remapToPy(i);
					}
				}	
			}
			return Sk.ffi.remapToPy(-1);
		});

	}, "Rect", []);

	function unpackKWA(kwa) {
		result = {};
		
		for(var i = 0; i < kwa.length; i+=2) {
			var key = Sk.ffi.remapToJs(kwa[i]);
			var val = Sk.ffi.remapToJs(kwa[i+1]);
			result[key] = val;
		}

		return result;
	}
	
	var Surface = Sk.misceval.buildClass(s, function($gbl, $loc) {

		$loc.blit = new Sk.builtin.func(function(self, source, dest, area, special_flags) {
			Sk.builtin.pyCheckArgs("blit", 3, 5);
			if(self.actor !== undefined) {
				throw new Sk.builtin.NotImplementedError("You can currently only blit to the screen surface");
			}
			
			if(!(source && source.actor && source.actor.attributes && source.actor.attributes.image)) {
				throw new Sk.builtin.TypeError("The source must be a pygame surface");
			}
			var i = loadedAssets[source.actor.attributes.image];

			var coords = Sk.ffi.remapToJs(dest);
			area = Sk.ffi.remapToJs(area);
			if(area && area.length >= 4) {
				cx.drawImage(i.image, area[0], area[1], area[2], area[3], coords[0], coords[1], area[2], area[3]);
			} else {
				cx.drawImage(i.image, coords[0], coords[1]);
			}
			


		});
		
		$loc.__init__ = new Sk.builtin.func(function(self, actor) {
			self.actor = actor;
		});
	});


	Sk.globals.Actor = Sk.misceval.buildClass(s, function($gbl, $loc) {
		
		$loc.distance_to = new Sk.builtin.func(function(self, target){
			Sk.builtin.pyCheckArgs("distance_to", 2, 2);

			var pos = Sk.ffi.remapToJs(target);
			var tx = 0;
			var ty = 0;
			if(pos) {
				tx = pos[0];
				ty = pos[1];
			} else {
				tx = Sk.ffi.remapToJs(getActorAttribute(target, Sk.ffi.remapToPy("x")));
				ty = Sk.ffi.remapToJs(getActorAttribute(target, Sk.ffi.remapToPy("y")));
			}
			
			var myx = Sk.ffi.remapToJs(getActorAttribute(self, Sk.ffi.remapToPy("x")));
			var myy = Sk.ffi.remapToJs(getActorAttribute(self, Sk.ffi.remapToPy("y")));
			
			var dx = tx - myx
			var dy = myy - ty
			return Sk.ffi.remapToPy(Math.sqrt(dx * dx + dy * dy));
		});
		
		$loc.angle_to = new Sk.builtin.func(function(self, target) {
			Sk.builtin.pyCheckArgs("angle_to", 2, 2);

			var pos = Sk.ffi.remapToJs(target);
			var tx = 0;
			var ty = 0;
			if(pos) {
				tx = pos[0];
				ty = pos[1];
			} else {
				tx = Sk.ffi.remapToJs(getActorAttribute(target, Sk.ffi.remapToPy("x")));
				ty = Sk.ffi.remapToJs(getActorAttribute(target, Sk.ffi.remapToPy("y")));
			}
			
			var myx = Sk.ffi.remapToJs(getActorAttribute(self, Sk.ffi.remapToPy("x")));
			var myy = Sk.ffi.remapToJs(getActorAttribute(self, Sk.ffi.remapToPy("y")));
			
			var dx = tx - myx
			var dy = myy - ty
			return Sk.ffi.remapToPy(Math.atan2(dy, dx) * 180 / Math.PI);
			
		});
		

		$loc.collidepoint = new Sk.builtin.func(function(self, pos) {
			Sk.builtin.pyCheckArgs("collidepoint", 2, 2);
			var c = Sk.ffi.remapToJs(pos);
			var pt = {
				x: c[0],
				y: c[1]
			}
			return new Sk.builtin.bool(pt.x >= self.attributes.x && pt.x <= self.attributes.right && pt.y >= self.attributes.y && pt.y <= self.attributes.bottom);
		});

		var anchors = {
			x: {
				left: 0.0,
				center: 0.5,
				middle: 0.5,
				right: 1.0
			},
			y: {
				top: 0.0,
				center: 0.5,
				middle: 0.5,
				bottom: 1.0
			}
		}

		function calculateAnchor(value, dim, total) {
			if(typeof value == 'string') {
				try {
					return total * anchors[dim][value];
				} catch (e){
					throw new Sk.builtin.ValueError(value + " is not a valid " + dim + "-anchor name");
				}
			}
			return value;
		}

		function transformAnchor(ax, ay, w, h, angle) {
			var theta = -angle * Math.PI / 180;
			var sinTheta = Math.sin(theta);
			var cosTheta = Math.cos(theta);

			var tw = abs(w * cosTheta) + abs(h * sinTheta);
		    var th = abs(w * sinTheta) + abs(h * cosTheta);

		    var cax = ax - w * 0.5;
		    var cay = ay - h * 0.5;

		    var rax = cax * cosTheta - cay * sinTheta;
		    var ray = cax * sinTheta + cay * cosTheta;

		    return {
		    	x: tw * 0.5 + rax,
		        y: th * 0.5 + ray
		    };

		}

		function updateAnchor(self) {
			var i = loadedAssets[self.attributes.image];
			if(i) {
				self.anchorVal.x = calculateAnchor(self.anchor[0], 'x', i.width);
				self.anchorVal.y = calculateAnchor(self.anchor[1], 'y', i.height);
			}		
		}


		$loc.__getattr__ = new Sk.builtin.func(getActorAttribute);

		$loc.__setattr__ = new Sk.builtin.func(updateActorAttribute);
//-----------------------------------
var init = function(kwa, self, name, pos) {	
					
			Sk.builtin.pyCheckArgs("_init_", 2, 2);
			self.id = idCount++;

			self.attributes = {
				x: 0,
				y: 0,
				angle: 0,
				scale: 1,
				image: Sk.ffi.remapToJs(name)
			};
			self.others = {};
			self.others._surf = Sk.misceval.callsim(Surface, self);

			self.anchor = ['center', 'center'];
			var args = unpackKWA(kwa);
			
			if(args.anchor) {
				self.anchor = args.anchor;
			}
			if(pos) {
				pos = Sk.ffi.remapToJs(pos);
			} else {
				if(args.pos) {
					pos = args.pos;
				} else {
					pos = [-55555,0];
				}
			}
			
			self.anchorVal = {x:0, y:0};
			var jsName = Sk.ffi.remapToJs(name); //ім'я ресурсу
			// ресурс завантажуємо у assets.images
            var error = false;
			var images_path = "/images/";
			var file_name = images_path + jsName + ".png";
            try {
                var image_data = fsToBrowse.read(file_name); // прочитано
                
                //throw new Error("Спеціально викликаємо помилку");
                
                var img = new Image;
    		    img.name = jsName;
    		    img.src = image_data;
			    
                img.onload = function () {
                    var a = img;
                    loadedAssets[img.name] = {
                                    image: img,
                                    name: img.name,
                                    type: "image",
                                    width: a.width,
                                    height: a.height
                    };
                    assets.images[jsName] = {src:img.src, width:a.width, height:a.height};
                    
                    //console.log(JSON.stringify(assets.images, null, 4));
                    console.log("LoadedAssets = ", loadedAssets);
                }
                
                img.onerror = function () {
                    if (Object.keys(assets.images).length === 0) {
                        PythonIDE.showHint("Помилка: ресурси Pygame Zero не завантажено!");  btnAssetColor ='#ff0000';  
                    }                         
                };
            } catch (err) {
                PythonIDE.showHint("Помилка: зображення '"+ jsName + "' не завантажено!"); btnAssetColor ='#ff0000'; 
                
                //console.log("ERROR",err);
                // файл не знайдено
                //alert(err.toString())
				error = true;
	        }
			if (error) {
				console.log("ERR");
            }
}
		
		init.co_kwargs = true;

		$loc.__init__ = new Sk.builtin.func(init);

		$loc.draw = new Sk.builtin.func(function(self) {
			if(loadedAssets[self.attributes.image]) {
				updateRectFromXY(self);
				var i = loadedAssets[self.attributes.image];
				var a = self.attributes;
				var radians = a.angle * Math.PI / 180;				
				cx.save();				
				cx.translate(a.x + self.anchorVal.x, a.y + self.anchorVal.y);
				cx.rotate(-radians);
				cx.translate(-a.x - self.anchorVal.x, -a.y - self.anchorVal.y);
				cx.drawImage(i.image, a.x, a.y, a.width*a.scale, a.height*a.scale);
				cx.restore();
			} else {
				//console.log(self.name + " not loaded yet...");
			}
		});
		
		$loc.__repr__ = new Sk.builtin.func(function(self) {

			return Sk.ffi.remapToPy(self.attributes.image + " (x:" + (self.attributes.x + self.anchorVal.x) + "," + (self.attributes.y + self.anchorVal.y) + ")");
		});
	}, 'Actor', [Sk.globals.Rect]);

	var EnumValue = Sk.misceval.buildClass(s, function($gbl, $loc) {
		
		$loc.__init__ = new Sk.builtin.func(function(self, enumName, key, value) {
			self.enumName = enumName;
			self.key = key;
			self.value = value;
		});

		$loc.__str__ = new Sk.builtin.func(function(self) {
			return new Sk.builtin.str(self.enumName + "." + self.key);
		});

		$loc.__getattr__ = new Sk.builtin.func(function(self, a) {
			switch(Sk.ffi.remapToJs(a)) {
				case 'name':
					return Sk.ffi.remapToPy(self.key);
				break;
				case 'value':
					return Sk.ffi.remapToPy(self.value);
				break;
			}
		});

		$loc.__int__ = new Sk.builtin.func(function(self) {
			return Sk.ffi.remapToPy(self.value);
		});

		$loc.__eq__ = new Sk.builtin.func(function(self, other) {
			var cmpTo = Sk.ffi.remapToJs(other);
			if(other.value !== undefined) {
				cmpTo = other.value;
			}
			return Sk.ffi.remapToPy(Sk.ffi.remapToJs(self.value) == cmpTo);
		});

	}, 'enum', []);

	var Enum = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__init__ = new Sk.builtin.func(function(self, name) {
			self.values = {};
			self.name = name;
		});

		$loc.__str__ = new Sk.builtin.func(function(self) {
			return new Sk.builtin.str("enum '" + self.name + "'");
		});
	}, 'Enum', []);

	var keysPressed = {

	}

	function isKeyPressed(key) {
		return new Sk.builtin.bool(keysPressed[key.toLowerCase()] == true);
	}

	var Keyboard = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__getattr__ = new Sk.builtin.func(function(self, name) {
			var key = Sk.ffi.remapToJs(name);
			if(key.match(/__/)) {
				return;
			}
			return isKeyPressed(key);
		});
	}, 'pgzero.keyboard.Keyboard', []);
	Sk.globals.keyboard = Sk.misceval.callsim(Keyboard);
	
	var mouse = Sk.misceval.buildClass(s, function($gbl, $loc) {
		var id = 1;
		function addVal(key, value) {
			if(value == undefined) {
				value = id++;
			}
			$loc[key] = Sk.misceval.callsim(EnumValue, "mouse", key, value);
		}
		addVal('LEFT');
		addVal('MIDDLE');
		addVal('RIGHT');
	}, 'mouse', [Enum]);

	Sk.globals.mouse = Sk.misceval.callsim(mouse, 'mouse');

	var keys = Sk.misceval.buildClass(s, function($gbl, $loc) {

		var values = {
			SPACE: 32,
			RETURN: 13,
			LEFT: 37,
			RIGHT: 39,
			UP: 38,
			DOWN: 40
		}

		for(var key in values) {
			$loc[key] = Sk.misceval.callsim(EnumValue, "keys", key, values[key]);
		}

	}, 'keys', [Enum]);
	Sk.globals.keys = Sk.misceval.callsim(keys, 'keys');

	var SurfacePainter = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.circle = new Sk.builtin.func(function(self, coords, radius, color) {
			Sk.builtin.pyCheckArgs("circle", arguments, 4, 4);

			var args = {
				coords: Sk.ffi.remapToJs(coords),
				radius: Sk.ffi.remapToJs(radius),
				color: Sk.ffi.remapToJs(color)
			} 
			cx.strokeStyle = getColor(args.color);
			cx.beginPath();
			cx.arc(args.coords[0], args.coords[1], args.radius, 0, 2 * Math.PI);
			cx.stroke();

		});

		$loc.rect = new Sk.builtin.func(function(self, rect, color) {
			Sk.builtin.pyCheckArgs("rect", 3, 3);
			var args = {
				x1: rect.coords.x1,
				y1: rect.coords.y1,
				x2: rect.coords.x2,
				y2: rect.coords.y2,
				color: Sk.ffi.remapToJs(color)
			}
			cx.strokeStyle = getColor(args.color);
			cx.beginPath();
			cx.rect(args.x1, args.y1, args.x2 - args.x1, args.y2 - args.y1);
			cx.stroke();
		});

		$loc.filled_rect = new Sk.builtin.func(function(self, rect, color) {
			Sk.builtin.pyCheckArgs("filled_rect", 3, 3);
			var args = {
				x1: rect.coords.x1,
				y1: rect.coords.y1,
				x2: rect.coords.x2,
				y2: rect.coords.y2,
				color: Sk.ffi.remapToJs(color)
			}
			cx.fillStyle = getColor(args.color);
			cx.beginPath();
			cx.rect(args.x1, args.y1, args.x2 - args.x1, args.y2 - args.y1);
			cx.fill();
		});

		$loc.line = new Sk.builtin.func(function(self, start, end, color) {
			Sk.builtin.pyCheckArgs("rect", 3, 3);
			var args = {
				start: Sk.ffi.remapToJs(start),
				end: Sk.ffi.remapToJs(end),
				color: Sk.ffi.remapToJs(color)
			}
			console.log("***** Start:",args.start[0],":",args.start[1])
			cx.strokeStyle = getColor(args.color);
			cx.beginPath();
			cx.moveTo(args.start[0], args.start[1]);
			cx.lineTo(args.end[0], args.end[1]);
			cx.stroke();
		});
		
		$loc.filled_circle = new Sk.builtin.func(function(self, pos, radius, color) {
			Sk.builtin.pyCheckArgs("filled_circle", arguments, 4, 4);
			
			var args = {
				coords: Sk.ffi.remapToJs(pos),
				radius: Sk.ffi.remapToJs(radius),
				color: Sk.ffi.remapToJs(color)
			};
			
			cx.fillStyle = getColor(args.color);
			cx.beginPath();
			cx.arc(args.coords[0], args.coords[1], args.radius, 0, 2 * Math.PI);
			cx.closePath();
			cx.fill();
		});

		var text =  function(kwa, self, text, pos) {
			Sk.builtin.pyCheckArgs("text", arguments, 2, 4);
			var jsText = Sk.ffi.remapToJs(text);
			
			//if(jsText.match(/GAME/)) debugger;
			props = unpackKWA(kwa);
			if(props.fontname === undefined) {
				props.fontname = "Arial";
			}
			if(props.fontsize === undefined) {
				props.fontsize = 18;
			}
			if(props.color === undefined) {
				props.color = 'white';
			}
			if(props.background) {
				cx.fillStyle = getColor(props.background);
				cx.fillRect(props.x, props.y, size.width, size.height);
			}
			if(props.ocolor === undefined) {
				props.ocolor = "#000";
			}
			if(props.owidth === undefined) {
				props.owidth = 0;
			}
			if(props.align === undefined) {
				props.align = "center";
			}
			if(props.angle === undefined) {
				props.angle = 0;
			}
			
			cx.fillStyle = getColor(props.color); 
			
			cx.shadowOffsetX = 0;
			cx.shadowOffsetY = 0;
			if(props.scolor){
			// Specify the shadow offset.
				cx.shadowOffsetX = 2;
				cx.shadowOffsetY = 2;
				cx.shadowColor = props.scolor;
			}		
			
			cx.font = 'bold '+props.fontsize + "px " + props.fontname;
			var lines = jsText.split("\n");
			var size = {
				height: cx.measureText("M").width * lines.length,
				width: cx.measureText(lines[0]).width,
				lineWidths: []
			}
			for(var i = 0; i < lines.length; i++) {
				var w = cx.measureText(lines[i]).width;
				size.lineWidths[i] = w;
				if( w > size.width) {
					size.width = w;
				}
			}
			
			updateCoordsFromProps(props, size, Sk.ffi.remapToJs(pos));
			cx.textBaseline = "top";	

			for(var i = 0; i < lines.length; i++) {
				var x = props.x;
				var yy = props.y;
				switch(props.align) {
					case 'center':
						x += (size.width - size.lineWidths[i]) / 2;
					break;
					case 'right':
						x += (size.width - size.lineWidths[i]);
					break;
				}
				
				cx.save();
				if(props.gcolor) {
					const grad=cx.createLinearGradient(0,0,0,props.fontsize);
					grad.addColorStop(0, props.color);
					grad.addColorStop(1, props.gcolor);
					cx.fillStyle = grad; 
			} 
				y = yy + (i * size.height)/2;
				if(props.alpha) { cx.globalAlpha = props.alpha; }
				cx.translate(x,y);
				cx.rotate(-props.angle*Math.PI/180);
				if(props.owidth) {
					cx.strokeStyle = getColor(props.ocolor);
					cx.lineWidth = props.owidth*4;
					cx.strokeText(lines[i], 0, 0);
				}	
				cx.fillText(lines[i], 0, 0);
				cx.restore();


			}
			
		};

		text.co_kwargs = true;
		$loc.text = new Sk.builtin.func(text);
	}, 'pgzero.screen.SurfacePainter', []);

	var Clock = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__init__ = new Sk.builtin.func(function(self) {
			self.callbacks = {};
		});

		$loc.schedule_unique = new Sk.builtin.func(function(self, callback, delay) {
			Sk.builtin.pyCheckArgs("schedule_unique", 3, 3);
			if(self.callbacks[callback]) {
				clearTimeout(self.callbacks[callback]);
				delete self.callbacks[callback];
			}
			self.callbacks[callback] = setTimeout(function() {
				delete self.callbacks[callback];
				Sk.misceval.callsimAsync(handlers, callback).then(function success(r) {}, function fail(e) {
					window.onerror(e);
				});
			}, Sk.ffi.remapToJs(delay) * 1000);
		});

		$loc.schedule = new Sk.builtin.func(function(self, callback, delay) {
			Sk.builtin.pyCheckArgs("schedule_unique", 3, 3);
			self.callbacks[callback] = setTimeout(function() {
				delete self.callbacks[callback];
				Sk.misceval.callsimAsync(handlers, callback).then(function success(r) {}, function fail(e) {
					window.onerror(e);
				});
			}, Sk.ffi.remapToJs(delay) * 1000);
		});
		
		$loc.schedule_interval = new Sk.builtin.func(function(self, callback, delay) {
			Sk.builtin.pyCheckArgs("schedule_schedule", 3, 3);
			self.callbacks[callback] = setInterval(function() {
				delete self.callbacks[callback];
				Sk.misceval.callsimAsync(handlers, callback).then(function success(r) {}, function fail(e) {
					window.onerror(e);
				});
			}, Sk.ffi.remapToJs(delay) * 1000);
		});
		
	}, 'pgzero.clock', []);


	Sk.globals.clock = Sk.misceval.callsim(Clock);

	var Sound = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__init__ = new Sk.builtin.func(function(self, name) {
			self.name = Sk.ffi.remapToJs(name);
		});

		$loc.play = new Sk.builtin.func(function(self) {
			if(!assets.sounds[self.name]) {
				throw new Sk.builtin.KeyError("No sound found like '" + jsName + "'. Are you sure the sound exists?");
			}
			assets.sounds[self.name].audio.play();
		});
	});

	var SoundLoader = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.__getattr__ = new Sk.builtin.func(function(self, name) {
			var sound = Sk.ffi.remapToJs(name);
			if(assets.sounds && assets.sounds[sound]) {
				return assets.sounds[sound].pySound;
			}
			throw new Sk.builtin.KeyError("No sound found like '" + sound + "'. Are you sure the sound exists?");
		});

	}, 'pgzero.loaders.SoundLoader', []);

	var Screen = Sk.misceval.buildClass(s, function($gbl, $loc) {
		$loc.clear = new Sk.builtin.func(function(self) {
			Sk.builtin.pyCheckArgs("clear", arguments, 1, 1);
			cx.clearRect(0, 0, width, height);
		});
		
		$loc.surface = Sk.misceval.callsim(Surface);

		$loc.blit = new Sk.builtin.func(function(self, image, coords) {
			Sk.builtin.pyCheckArgs("blit", arguments, 3, 3);
			coords = Sk.ffi.remapToJs(coords);
			var jsName = Sk.ffi.remapToJs(image);
			if(!loadedAssets[jsName]) {
				throw new Sk.builtin.KeyError("No image found like '" + jsName + "'. Are you sure the image exists?");
			}
			cx.drawImage(loadedAssets[jsName].image, coords[0], coords[1]);
		});

		$loc.fill = new Sk.builtin.func(function(self, color) {
			Sk.builtin.pyCheckArgs("fill", arguments, 2, 2);

			var rgb = Sk.ffi.remapToJs(color);
			cx.fillStyle = getColor(rgb);
			cx.fillRect(0, 0, width, height);
			
		});

		$loc.draw = Sk.misceval.callsim(SurfacePainter);

	}, 'pgzero.screen.Screen', []);

	

	s.go = new Sk.builtin.func(function() {

		// create globals
		Sk.globals.screen = Sk.misceval.callsim(Screen);
		
		width = 800;
		if(Sk.globals.WIDTH) {
			width = Sk.ffi.remapToJs(Sk.globals.WIDTH);
		}
		
		height = 600;
		if(Sk.globals.HEIGHT) {
			height = Sk.ffi.remapToJs(Sk.globals.HEIGHT);
		}

		if(Sk.globals.TITLE) {
			var title = PythonIDE.sanitize(Sk.ffi.remapToJs(Sk.globals.TITLE));
			$('#dlg').dialog({title:title});
		}

// ----------------------- 	   
		PythonIDE.python.output('<canvas id="PGZcanvas" width="' + width + '" height="' + height + '"></canvas>', true);	    


		document.activeElement.blur();

	    var jqCanvas = $('#PGZcanvas');    
	    canvas = jqCanvas[0];
	    cx = canvas.getContext("2d");
		document.addEventListener('contextmenu', event => event.preventDefault());
		var lastUpdate = new Date().getTime()
	    function update() {
	    	var tasks = [];
			// process animations
			for(var id in animations) {
				var a = animations[id];
				var now = (new Date).getTime();
				a.progress = (now - a.startTime) / (a.duration * 1000);
				if(a.progress >= 1) {
					a.progress = 1;
					if(a.on_finished) {
						tasks.push(Sk.misceval.callsimAsync(handlers, a.on_finished).then(function success(r) {
						}, function fail(e) {
							window.onerror(e);
						}));
					}
				}
				for(var key in a.targets) {
					var x = a.progress;
					var y = x;
					switch(a.tween) {
						case 'bounce_end':
							y = 1 - Math.abs(Math.cos(3 * Math.PI * x * x) * Math.exp(-3 * x));
						break;
						case 'accelerate':
						break;
						case 'decelerate':
						break;
						case 'accel_decel':
						break;
						case 'start_elastic':
						break;
						case 'end_elastic':
						break;
						case 'bounce_start':
						break;
						case 'bounce_start_end':
						break;
						
					}
					var newVal = ((a.targets[key].end - a.targets[key].start) * y) + a.targets[key].start;
					updateActorAttribute(a.object, Sk.ffi.remapToPy(key), Sk.ffi.remapToPy(newVal));
				}
				if(a.progress ==1 ) {
					delete animations[a.id];
				}
			}
			
	    	if(Sk.globals.update) { /*
	    		if(Sk.globals.update.func_code.length > 0) {
					var newTime = new Date().getTime();
					var dt = (newTime-lastUpdate) / 1000;					
					lastUpdate = new Date().getTime();
    				tasks.push(Sk.misceval.callsimAsync(handlers, Sk.globals.update, new Sk.ffi.remapToPy(dt)));
    			} else { */
    				tasks.push(Sk.misceval.callsimAsync(handlers, Sk.globals.update));
    			//}
	    	}

	    	if(Sk.globals.draw) {
	    		Sk.misceval.callsim(Sk.globals.draw);
	    		//tasks.push(Sk.misceval.callsimAsync(handlers, Sk.globals.draw));
	    	}

			var p = Promise.all(tasks).then(function() {
				window.requestAnimationFrame(update);	
				//update();
			}, function(e) {
				PythonIDE.handleError(e);
			}).catch(function(e) {
				PythonIDE.handleError(e);
			}); 
			return p;
			

	    	
	    }

	    // add event handlers
	    if(Sk.globals.on_mouse_down) {
    		jqCanvas.on('mousedown', function(e) {	
				var arg =[0,0];			
				var mouseButton = 0;
				if (e.buttons === 1) {mouseButton= Sk.globals.mouse.LEFT}
				if (e.buttons === 4) {mouseButton= Sk.globals.mouse.MIDDLE}
				if (e.buttons === 2) {mouseButton= Sk.globals.mouse.RIGHT}
				var params = Sk.globals.on_mouse_down.func_code.co_varnames;
				
				function getParams() {
					if (params.indexOf('pos')>-1) {
						arg[params.indexOf('pos')] = pos;
					}
					if (params.indexOf('button')>-1) {
						arg[params.indexOf('button')] = mouseButton;
					}
				}
				
				if (!params) { params =[]; }				
    			var pos = new Sk.builtin.tuple([Math.round(e.offsetX), Math.round(e.offsetY)]);
    			
    			if (params.length === 2) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_down, arg[0], arg[1]);
				} else
				if (params.length === 1) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_down, arg[0]);
				} else {
							Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_down); //no param
						}
    			
    		});
    	}
    	
    	if(Sk.globals.on_mouse_up) {
    		jqCanvas.on('mouseup', function(e) {	
				var arg =[0,0];				
				var mouseButton = 1;				
				var params = Sk.globals.on_mouse_up.func_code.co_varnames;
				
				function getParams() {
					if (params.indexOf('pos')>-1) {
						arg[params.indexOf('pos')] = pos;
					}
					if (params.indexOf('button')>-1) {
						arg[params.indexOf('button')] = mouseButton;
					}
				}
				
				if (!params) { params =[]; }				
    			var pos = new Sk.builtin.tuple([Math.round(e.offsetX), Math.round(e.offsetY)]);
    			
    			if (params.length === 2) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_up, arg[0], arg[1]);
				} else
				if (params.length === 1) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_up, arg[0]);
				} else {
							Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_up); //no param
						}
    			
    		});
    	}

    	if(Sk.globals.on_mouse_move) {
			var px = -1;
			var py;
    		jqCanvas.on('mousemove', function(e) {
				var mouseButton = 0;
				if (e.buttons === 1) {mouseButton= Sk.globals.mouse.LEFT}
				if (e.buttons === 4) {mouseButton= Sk.globals.mouse.MIDDLE}
				if (e.buttons === 2) {mouseButton= Sk.globals.mouse.RIGHT}
				
				var arg =[0,0,0];
				var params = Sk.globals.on_mouse_move.func_code.co_varnames;
				
				function getParams() {
					if (params.indexOf('pos')>-1) {
						arg[params.indexOf('pos')] = pos;
					}
					if (params.indexOf('rel')>-1) {
						arg[params.indexOf('rel')] = rel;
					}
					if (params.indexOf('buttons')>-1) {
						arg[params.indexOf('buttons')] = mouseButton;
					}
				}	

    			var pos = new Sk.builtin.tuple([Math.round(e.offsetX), Math.round(e.offsetY)]);

    			if (px<0) {
					px =pos.v[0];
					px =pos.v[1];
				}
					    			
    			var rel = new Sk.builtin.tuple([pos.v[0]-px, pos.v[1]-py]);
    			px =pos.v[0];
    			py =pos.v[1];				
				
				if (!params) { params =[]; }				

    			if (params.length === 3) {				
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_move, arg[0], arg[1], arg[2]);					
				} else
				if (params.length === 2) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_move, arg[0], arg[1]);
				} else
				if (params.length === 1) {
					getParams();
					Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_move, arg[0]);
				} else {		
    			 Sk.misceval.callsimAsync(handlers, Sk.globals.on_mouse_move);
    			} 
    			
    		});	
    	}


	    Sk.globals.sounds = Sk.misceval.callsim(SoundLoader);
	    
    	// wait for assets to load
    	Promise.all(promises).then(function() {
    		update();
    	}, function(e) {
    		PythonIDE.handleError(e);
    	}).catch(PythonIDE.handleError);	
    	

    	PythonIDE.keyHandlers.push(function(e) {
    		var key = e.key.replace("Arrow", "").toLowerCase();
    		switch(key) {
    			case " ":
    				key = "space";
    			break;
    			case "enter":
    				key = "return";
    			break;
    		}
		
    		if(e.type == "keydown") {
    			keysPressed[key] = true;
    			if(Sk.globals.on_key_down) {
					var pyKey = Sk.misceval.callsim(EnumValue, "keys", key.toUpperCase(), e.keyCode);
    				if(Sk.globals.on_key_down.func_code.length > 0) {
	    				Sk.misceval.callsimAsync(handlers, Sk.globals.on_key_down, pyKey).then(function success(r) {}, function fail(e) {
							window.onerror(e);
						});
	    			} else {
	    				Sk.misceval.callsimAsync(handlers, Sk.globals.on_key_down).then(function success(r) {}, function fail(e) {
							window.onerror(e);
						});
	    			}
    				
    			}
    		}
    		if(e.type == "keyup") {
    			keysPressed[key] = false;	
    		}
    	});
	
    	

	    return PythonIDE.runAsync(function(resolve, reject) {
	    });
		
	});

	function loadAssets() {
		
		return promises;
	}

	// load assets
    if(assets) {

    	// load sounds
    	if(assets.sounds) {
    		for(var name in assets.sounds) {
    			promises.push(new Promise(function(resolve, reject) {
    				assets.sounds[name].pySound = Sk.misceval.callsim(Sound, Sk.ffi.remapToPy(name));
    				assets.sounds[name].audio = new Audio(assets.sounds[name].src);
    				assets.sounds[name].audio.oncanplaythrough = function() {
    					resolve();	
    				}
    				assets.sounds[name].audio.label = name;
    				assets.sounds[name].audio.onerror = function(e) {
    					PythonIDE.handleError("Could not load sound: " + e.currentTarget.label);
    				}
    				assets.sounds[name].audio.load();
    			}));
    		}
    	}

    	// load images
    	if(assets.images) {
			
		    for(var name in assets.images) {
	    		promises.push(new Promise(function(resolve, reject) {
					var img = new Image;
    				img.name = name;
    				img.addEventListener("load", function(e) {
    					var a = assets.images[img.name];
    					if(!a.width) {
    						a.width = img.width * (a.height / img.height);
    					}
    					if(!a.width) {
    						a.width = img.width;
    					}
    					if(!a.height) {
    						a.height = img.height * (a.width / img.width);
    					}
    					if(!a.height) {
    						a.height = img.height;
    					}
    					loadedAssets[img.name] = {
			    			image: img,
			    			name: img.name,
			    			type: "image",
			    			width: a.width,
			    			height: a.height
			    		};
    					resolve(img.img);
    					
    				}, false);
    				img.addEventListener("error", function(e) {
    					throw new Sk.builtin.Exception("Could not load image " + img.name + ". Images can only be loaded from servers that have enabled CORS - try a different URL");
    					reject("Could not load image " + img.name);
    				});
    				img.src = assets.images[img.name].src;
				}));
	    	}
	    }
    }
    return s;
	
};
