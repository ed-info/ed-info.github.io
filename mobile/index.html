<!DOCTYPE html>
<html>
<head>
    <style>
        #loading {
            position: absolute;
            top: 40%;
            width: 33%;
            left: 33%;
            text-align: center;
            background-color: #CCC;
            border-radius: 10px;
            padding: 20px;
            animation: loading 2s alternate infinite;
            border: 1px solid #000;
        }

        @keyframes loading {
            from {
                background-color: #CCC;
            }

            to {
                background-color: #0C0;
            }
        }        
 
    </style>

    <meta charset="UTF-8">
    <title>єPython - програмувати просто!</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script src="./lib/cm/codemirror.js"></script>
    <script src="./lib/cm/active-line.js"></script>
    <script src="./lib/cm/show-hint.js"></script>
    <script src="./lib/cm/python.js"></script>
    <script src="./lib/cm/xml.js"></script>
    <script src="./lib/cm/javascript.js"></script>
    <script src="./lib/cm/css.js"></script>
    <script src="./lib/cm/htmlmixed.js"></script>
    <link rel="stylesheet" href="./lib/cm/codemirror.css">

    <link rel="stylesheet" href="./lib/cm/cobalt.css">
    <link rel="stylesheet" href="./lib/cm/blackboard.css">

    <link rel="stylesheet" href="./jquery/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="./jquery/jquery-1.12.4.js"></script>
    <script src="./jquery/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./lib/font-awesome.min.css">
    <script src="./lib/p5.js"></script>
    <script src="./lib/jq/jquery.ui.touch-punch.min.js"></script>
    <script src="./lib/lib.js"></script>
    <script src="./lib/skulpt/skulpt.min.js"></script>
    <script src="./lib/skulpt/skulpt-stdlib.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    
</head>
<body>
    <div id="loading">
        Завантаження...
    </div>
	<img src="logo.png" alt="logo" width="280" height="70">
    <div id="holder" class="holder" style="display:none">
        <span id="file_tabs"><span class="file_tab file_tab_selected">mycode.py</span></span>
        <pre>
            <div id="editor"></div>
        </pre>
    </div>
    <script>
		var assets = {};
		function encode(str) {
			return window.btoa(unescape(encodeURIComponent(str)));
		}
		function decode(str) {
			return decodeURIComponent(escape(window.atob(str)));
		}
		var uhash=window.location.hash;
		var uuhash=decode(uhash.substring(1));		
        var files = uuhash;
        
        try {
            PythonIDE.files = JSON.parse(files);
        } catch (e) {
            PythonIDE.files['mycode.py'] = files;
        }
		
        PythonIDE.currentFile = 'mycode.py';
        PythonIDE.projectName = 'mycode.py'.replace(".py", "");
        PythonIDE.updateFileTabs();
    </script>
    <div id="hintBar"></div>
    <span id="footer">
        <img title="Виконати" alt="Натисніть, щоб виконати код" id="btn_run" class="toolButton" src="./media/play.png">
        <img alt="Припинити виконання" title="Припинити" class="toolButton hiddenButton" src="./media/stop.png" id="btn_stopRunning">
        <img alt="Натисніть, щоб показати/сховати кнопки" title="Показати/сховати кнопки" class="toolButton" src="./media/ttools.png" id="btn_tools">
        <img title="Відкрити консоль" alt="Показати вікно консолі" id="btn_show_output" class="toolButton hiddenButton" src="./media/console.png">
        <img title="Завантажити, зберегти та поділитися" alt="Завантажте, збережіть і поділіться власним кодом" id="btn_show_share" class="toolButton hiddenButton" src="./media/share.png">
        <img title="Налаштування" alt="Налаштувати екран" id="btn_show_settings" class="toolButton hiddenButton" src="./media/settings.png">
    </span>
   
    <div id="recover" title="Відновлення коду" style="display:none"></div>
    <div id="dlg" title="mycode.py" style="display:none">
        <div id="p5Sketch"></div>
        <div id="output"></div>
        <canvas id="myChart" style="width:100%;max-width:600px;max-height:500px;background-color: #CCC;display:none"></canvas>
    </div>
    <div id="save" title="Зберегти або отримати для редагування" style="display:none;">
        <fieldset>
            <legend>Зберегти поточний файл:</legend>

            <div class="save_option" style="background-color: #82ffab;" id="btnDownload">
                <h2><i class="fa fa-save" ></i> Зберегти (Завантажити)</h2>
                <p>Поточний файл буде завантажено на цей комп’ютер.</p>
               
                <h3><i class="fa fa-keyboard-o"></i> Ctrl + Alt + S</h3>
            </div>
        </fieldset>

        <fieldset>
            <legend>Отримати файл:</legend>
            <form class="box" method="post" action="#" enctype="multipart/form-data" style="background-color: #e9ff89;">
                <div class="box__input" >
                    <input class="box__file" type="file" name="files[]" id="file"
                        data-multiple-caption="{count} files selected" multiple />
                    <label style="display:block;text-align:center;" for="file"><strong>Виберіть
                            Python-файл</strong><span class="box__dragndrop"> або перетягніть його сюди, щоб
                            відвантажити з комп’ютера</span>.</label>
                </div>
            </form>
        </fieldset>
       <div id="btn_PGZ" ><button style="position:fixed;z-index:999999 !important;bottom:120px;right:10px;background-color:'+btnAssetColor+'" 
			name="btn_PGZ">
		   <i class="fa fa-file-image-o"></i> Галерея </button></div>
    </div>
     <div id="PGZAssetManager" title="Галерея ресурсів" style="display:none;">   
     </div>   
    <div id="project_settings" title="Проєкт" style="display:none">
        <p>Перейменування проєкту допоможе вам упорядкувати збережений код</p>
        <label for="txt_project_name">Назва проєкту:</label><input id="txt_project_name" name="txt_project_name"
            value="mycode">
        <button id="btn_project_ok">OK</button>
        <button id="btn_project_cancel">Скасувати</button>
    </div>

    <div id="file_settings" title="Файл" style="display:none">
        <p>Будьте обережні: якщо ви вирішите видалити файл, ви не зможете відновити його, якщо не збережете копію</p>
        <label for="txt_file_name">Перейменувати файл:</label><input id="txt_file_name" name="txt_file_name" value="">
        <button id="btn_file_rename">Перейменувати</button>
        <button id="btn_file_delete">Видалити</button>
        <button id="btn_file_cancel">Скасувати</button>
    </div>

    <div id="settings" title="Налаштування" style="display:none">
        <fieldset>
            <legend>Розміри тексту</legend>
            <label for="txt_code_size">Розмір шрифту коду:</label><input type="text" id="txt_code_size" readonly>
            <div id="slider_code_size" class="slider"></div>
            <label for="txt_output_size">Розмір шрифту тексту:</label><input type="text" id="txt_output_size"
                readonly>
            <div id="slider_output_size" class="slider"></div>
        </fieldset>

        <fieldset>
            <legend>Кольори редактора</legend>
            <div id="radio_code_style">
                <p>Більш світлі кольори чудово підходять для кодування вдень. Деякі люди віддають перевагу кодуванню
                    вночі:</p>
                <input type="radio" id="radio_code_style_light" name="radio_code_style" checked="checked"><label
                    for="radio_code_style_light">День</label>
                <input type="radio" id="radio_code_style_dusk" name="radio_code_style"><label
                    for="radio_code_style_dusk">Сутінки</label>
                <input type="radio" id="radio_code_style_dark" name="radio_code_style"><label
                    for="radio_code_style_dark">Ніч</label>
            </div>
        </fieldset>

        <fieldset>
            <legend>Кольори консолі</legend>
            <p>Темніші кольори більше схожі на командний рядок. Світліші кольори більше схожі на вікно програми:</p>
            <div id="radio_output_style">
                <input type="radio" id="radio_output_style_light" name="radio_output_style"><label
                    for="radio_output_style_light">День</label>
                <input type="radio" id="radio_output_style_dusk" name="radio_output_style"><label
                    for="radio_output_style_dusk">Сутінки</label>
                <input type="radio" id="radio_output_style_dark" name="radio_output_style" checked="checked"><label
                    for="radio_output_style_dark">Ніч</label>
            </div>
        </fieldset>

        <fieldset>
            <legend>Режим запуску</legend>
            <p>Виконання коду рядок за рядком може бути корисним способом пошуку помилок</p>
            <div id="radio_run_mode">
                <input type="radio" id="radio_run_mode_all" name="radio_run_mode" checked="checked"><label
                    for="radio_run_mode_all">Уся програма</label>
                <input type="radio" id="radio_run_mode_single" name="radio_run_mode"><label
                    for="radio_run_mode_single">Рядок за рядком</label>
                <input type="radio" id="radio_run_mode_anim" name="radio_run_mode"><label
                    for="radio_run_mode_anim">Анімація рядків</label>
            </div>
            <p>Вибір довшого часу між анімацією кожного рядка допоможе вам зрозуміти та пояснити код під час його
                виконання</p>
            <label for="txt_step_anim_time">Час затримки між виконанням кожного рядка:</label><input type="text"
                id="txt_step_anim_time" readonly>
            <div id="slider_step_anim_time" class="slider"></div>
            <p>Зробивши вікно виведення прозорим, ви зможете бачити свій код під ним</p>
            <label for="txt_output_transparency">Прозорість вікна</label><input type="text" id="txt_output_transparency"
                readonly>
            <div id="slider_output_transparency" class="slider"></div>
        </fieldset>
    </div>

    <script>
        var toolsVisible = false;
        $(function () {
            $('#loading').hide();
            $('#holder').show();
            PythonIDE.init('normal');
        });
        
		function loadAsset() {
				
			const file = document.getElementById("asset-file").files[0];
			if (file.name.match(/\.(json)$/)) {				
				const reader = new FileReader();
				reader.addEventListener(
					"load",
					() => {
		
					PythonIDE.files['assets.json'] = reader.result;
					PythonIDE.editor.refresh();	
				},
				false,
				);
				if (file) {
					reader.readAsText(file);
				}
			}
		  else {
					PythonIDE.showHint("Непідтримуваний формат файлу");	
					
			}
				
		}
				
	function getFile() {
		const file = document.getElementById("choose-file").files[0];
		const reader = new FileReader();
		reader.addEventListener(
			"load",
			() => {
		// convert image file to base64 string
			localStorage.setItem(file.name,reader.result);
			},
			false,
		);

		if (file) {
			reader.readAsDataURL(file);
		}
	}

    let btnRun = document.querySelector("#btn_run");
    function runSketch(event) {
        runit();
    }
    btnRun.addEventListener('click', runSketch);

    function runit() { 
		document.querySelector("#myChart").style.display = "none";
		Sk.canvas = "myChart";
		Sk.p5Sketch = "p5Sketch";
        const cnvs = [...document.querySelectorAll(`[id^="defaultCanvas"]`),];
        cnvs.forEach((cnv) => {
            //cnv.style = "display:none";
            cnv.remove();
        });
    } 
    </script>
<script>
unction getImageData(url, callback) {
		  var xhr = new XMLHttpRequest();
		  xhr.onload = function() {
		    var reader = new FileReader();
		    reader.onloadend = function() {
		      callback(reader.result);
		    }
		    reader.readAsDataURL(xhr.response);
		  };
		  xhr.open('GET', url);
		  xhr.responseType = 'blob';
		  xhr.send();
		}
$(document).ready(function(){
  function showAssetManager(a) {
	  assetType='images';
	    	var html = '<style>.asset_img{width:50px;float:left;margin-right:5px;} .asset{display:inline-block;background-color:#FF9;padding:5px;margin:5px;border-radius:10px;border: solid 1px #000;}</style>У вебверсії Pygame Zero зображення та звуки перед використання необхідно попередньо завантажити до середовища програмування!<br>';
	    		    	
	    	html += '<fieldset id="pgz_assets_images"><legend>Зображення</legend>';
	    	html += '<p>Перед використанням оберіть та завантажте потрібні файли зображень. </p>';
	    	html += '<p>Підтримувані типи: .jpg, .png та .gif. </p><br>';	    	
	    	html +=  '<div>Зображення: <input type="file" id="choose-file" name="choose-file" onchange="getFile()"/><button class="btn_asset" id="btn_asset_add_image">Додати зображення</button></div>';
	    	switch(assetType) {
	    		case 'images':
	    			if(assets.images) {
	    				for(var name in assets.images) {							
	    					var image = assets.images[name];
	    					html += '<div class="asset" id="asset_image_' + name + '"><img class="asset_img" src="' + image.src + '">';
	    					html += '<div><b>' + name + '</b></div>';
	    					var src = image.src;
	    					if(src.match(/data:image/)) {
	    						src="base64";
	    					} else {
	    						getImageData(src, function(data) {
	    							
	    						})
	    					};
	    					html += '<button id="btn_asset_delete_image_' + name + '" class="btn_trash"><i class="fa fa-trash"></i></button>'
	    					html += '</div>';
	    				}
	    			}
	    		break;
	    		case 'sounds':
	    			if(assets.sounds) {
	    				for(var name in assets.sounds) {
	    					var sound = assets.sounds[name];
	    					html += '<div class="asset" id="asset_sound_' + name + '"><audio class="asset_snd" controls src="' + sound.src + '"></audio>';
	    					html += '<div><b>' + name + '</b></div>';
	    					html += '<div class="btn_trash"></div><button id="btn_asset_delete_sound_' + name + '><i class="fa fa-trash"></i></button></div>'
	    					html += '</div>';
	    				}
	    			}
	    		break;
	    	}
	    	html += '</fieldset>';
	    	html += '<button id="btn_AssetManager_ok" class="btn_asset"><i class="fa fa-check"></i> Гаразд</button>';
	    	html += '<button id="btn_AssetManager_cancel" class="btn_asset"><i class="fa fa-times"></i> Скасувати</button>';
	    	
	    	html += '<div  style="position:absolute;bottom:0;left:0;display:inline-block;">Інформація про використані ресурси (зображення та звуки) зберігається у файлі assets.json.<br><button id="btnAssetSave"> Зберегти ресурси</button>';
	    	html += '<p> Використати ресурси </p><input type="file" id="asset-file" name="asset-file" onchange="loadAsset()"/><button id="btnAssetLoad"> Використати</button></div>';
	    	html += '</div>';
  $("#PGZAssetManager").empty();   	
  $("#PGZAssetManager").append(html);
  }
  $("#btn_PGZ").click(function(){
   	    	$('#PGZAssetManager').dialog( {
	    		width: window.innerWidth * .8,
	    		height: window.innerHeight * .8  });  
	if(PythonIDE.files['assets.json']) {
				assets = JSON.parse(PythonIDE.files['assets.json']);
				
			}
		showAssetManager(false);	
  });
  
$(document).on('click','#btnAssetSave', function() {  
			 console.log('asset save');		
			 if(PythonIDE.files['assets.json']) {				
					var blob = new Blob([PythonIDE.files['assets.json']], {type : "text/plain", endings: "transparent"});
					saveAs(blob, 'assets.json');
				}	
  });

$(document).on('click','#btnAssetLoad', function() {  
			 console.log('asset load');	
			 if(PythonIDE.files['assets.json'] && reloadAssets) {
				assets = JSON.parse(PythonIDE.files['assets.json']);
				PythonIDE.updateFileTabs();
				showAssetManager(false);
			 }
 });
$(document).on('click','#btn_AssetManager_ok', function() { 
	PythonIDE.files['assets.json'] = JSON.stringify(assets, null, 2);
	PythonIDE.updateFileTabs();
	$('#PGZAssetManager').dialog('close');
 });
$(document).on('click','#btn_asset_add_image', function() {
	console.log('add');
	if(!assets.images) {
    							assets.images = {};
    						}    						
    						var url = document.getElementById("choose-file").files[0].name;
    						var imageData = localStorage.getItem(url)   						
							var name = url.split(".")[0];
							name = name.toLowerCase();
							assets.images[name] = {src:imageData};	
		    				showAssetManager(false);
		    				
 }); 
 
$(document).on('click','#btn_AssetManager_cancel', function() { 
	 $('#PGZAssetManager').dialog("close");
 }); 
$(document).on('click','.btn_trash', function(e) {  
				var parts = e.currentTarget.id.split("_");
				console.log('delete',parts);
				var name = parts[4];
	    		var type = parts[3];
	    		$('#asset_' + type + '_' + name).remove();
	    		delete assets[type + "s"][name];
			});	   	
	    	
});
</script>
    
    
</body>
</html>
